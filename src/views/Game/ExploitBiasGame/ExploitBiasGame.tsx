import style from './style.module.css';
import { useTranslation } from 'react-i18next';
import Header from '../../../components/Header/Header';
import Footer from '../../../components/Footer/Footer';
import { useEffect, useState } from 'react';
import { useAtom } from 'jotai';
import { modelAtom, classificationResultAtom, scoresAtom } from '../../../atoms/state';
import { Button, Webcam } from '@knicos/genai-base';
import { loadMobileNetModel } from '../../../services/loadModel';
import { classifyImage } from '../../../utils/classifyImage';
import { ClassificationResults } from '../../../components/ClassificationResults/ClassificationResults';
import CountdownTimer from '../../../components/CountDownTimer/CountDownTimer';
import { useNavigate } from 'react-router-dom';

/**
 * Bias game with own images using live webcam classification
 * @returns ExploitBiasGame view
 */
export default function ExploitBiasGame() {
    //const classTerms = ['prison', 'monitor', 'pizza', 'book']; // TODO: Korvataan ammateilla sitten joskus
    const classTerms = ['prison', 'monitor'];
    const { t } = useTranslation();
    const navigate = useNavigate();
    const [model, setModel] = useAtom(modelAtom);
    const [, setClassificationResult] = useAtom(classificationResultAtom);
    const [scores, setScores] = useAtom(scoresAtom);
    const [score, setScore] = useState(0);
    const [classifyTerm, setClassifyTerm] = useState('');
    const [isCameraActive, setIsCameraActive] = useState(false);
    const [captureOn, setCameraOn] = useState(false);
    const [restart, setRestart] = useState(false);
    const [disableMoveNext, setDisableMoveNext] = useState(false);
    const [phase, setPhase] = useState(0);
    const [level, setLevel] = useState(1);

    // Ladataan malli tarvittaessa
    useEffect(() => {
        if (!model) {
            loadMobileNetModel().then(setModel);
        }
    }, [model, setModel]);

    const testPrint = () => {
        console.log(scores);
    };
    const getNextTerm = (index: number): string => {
        return classTerms[index];
    };

    // Luokittelu canvas-kuvasta
    const handleCapture = async (canvas: HTMLCanvasElement) => {
        if (!model) return;
        try {
            const results = await classifyImage(model, canvas, 100);
            const result = results.filter((r) => r.className.toLowerCase().includes(`${classifyTerm}`));
            if (disableMoveNext && result.length > 0) {
                const currentScore = Math.floor(result[0].probability * 10000) / 100;
                if (score < currentScore) {
                    setScore(currentScore);
                    console.log(currentScore);
                }
            }
            setClassificationResult(results.slice(0, 3)); // Top 3
        } catch (err) {
            console.error('Luokittelu ep채onnistui:', err);
            setClassificationResult(null);
        }
    };

    const moveToNextPhase = () => {
        setDisableMoveNext(true);
        if (phase === 0) {
            setCameraOn(true);
            setPhase(1);
            setClassifyTerm(getNextTerm(0));
        }
        if (phase === 1) {
            // save lowscore from phase 2
            setScores([...scores, { className: classifyTerm, lowScore: score, topScore: 0 }]);
            setPhase(2);
        } else if (phase === 2) {
            // update the atomic scores
            const updatedScores = scores.map((s) => (s.className === classifyTerm ? { ...s, topScore: score } : s));
            setScores(updatedScores);

            // Move to next classify term
            const nextLevel = level + 1;
            setLevel(nextLevel);
            if (nextLevel > classTerms.length) {
                console.log('game over', scores);
                setCameraOn(false);
                setPhase(3);
            } else {
                setClassifyTerm(getNextTerm(nextLevel - 1));
                setPhase(1);
            }
        }
        setScore(0);
        setRestart(true);
    };

    const moveToScores = () => {
        navigate('/game/own/scores');
    };

    return (
        <div className={style.container}>
            <Header title={t('common.title')} />
            <div className={style.innerContainer}>
                <div className={style.innerContainer}>
                    <h2>{t('game.own.title')}</h2>
                    <p>
                        Sana : {classifyTerm} Pisteet: {score}
                    </p>
                    <p>
                        Vaihe: {phase} Kentt채: {level}
                    </p>
                    {!isCameraActive && (
                        <div style={{ marginTop: '1rem' }}>{t('webcam.notAvailable', 'Kamera k채ynnistyy')}</div>
                    )}
                    <Webcam
                        size={224}
                        interval={200} // Luokittelu v채li
                        capture={captureOn}
                        disable={false}
                        onCapture={handleCapture}
                        onActivated={setIsCameraActive}
                        onFatal={() => console.error('Webcam failure')}
                    />
                    <ClassificationResults />
                    {/**Testipainike */}
                    {phase !== 0 && (
                        <Button
                            sx={{ fontSize: '14pt', minWidth: '140px', marginTop: '16px' }}
                            variant="contained"
                            onClick={() => {
                                setCameraOn((prev) => !prev);
                            }}
                        >
                            {captureOn ? 'Break' : 'Start'}
                        </Button>
                    )}
                    {phase !== 3 && (
                        <Button
                            sx={{ fontSize: '14pt', minWidth: '140px', marginTop: '16px' }}
                            variant="contained"
                            onClick={moveToNextPhase}
                            disabled={disableMoveNext}
                        >
                            {phase === 0 && 'Aloita'}
                            {phase !== 0 && (
                                <CountdownTimer
                                    setDisableMoveNext={setDisableMoveNext}
                                    restart={restart}
                                    setRestart={setRestart}
                                />
                            )}
                        </Button>
                    )}{' '}
                    {/**Testipainike */}
                    <Button
                        sx={{ fontSize: '14pt', minWidth: '140px', marginTop: '16px' }}
                        variant="outlined"
                        onClick={testPrint}
                    >
                        Printtaa score
                    </Button>
                    {phase === 3 && (
                        <Button
                            sx={{ fontSize: '14pt', minWidth: '140px', marginTop: '16px' }}
                            variant="outlined"
                            onClick={moveToScores}
                        >
                            Siirry tuloksiin
                        </Button>
                    )}
                </div>
            </div>
            <Footer />
        </div>
    );
}
