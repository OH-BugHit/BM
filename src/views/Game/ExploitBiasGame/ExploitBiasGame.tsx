import style from './style.module.css';
import { useTranslation } from 'react-i18next';
import Header from '../../../components/Header/Header';
import Footer from '../../../components/Footer/Footer';
import { useEffect, useState } from 'react';
import { useAtom } from 'jotai';
import { imageAtom, modelAtom, classificationResultAtom } from '../../../atoms/state';
import { Button } from '@knicos/genai-base';
import CameraCapture from '../../../components/CameraCapture/CameraCapture';
import FileUploadCapture from '../../../components/FileUploader/FileUploadCapture';
import { loadMobileNetModel } from '../../../services/loadModel';
import { classifyImage } from '../../../utils/classifyImage';

/**
 * Bias game with own images
 * @returns OwnGame view
 */
export default function ExploitBiasGame() {
    const { t } = useTranslation();
    const [image, setImage] = useAtom(imageAtom);
    const [hasCaptured, setHasCaptured] = useState(false);
    const [method, setMethod] = useState<'camera' | 'upload' | null>(null);
    const [model, setModel] = useAtom(modelAtom);
    const [classificationResult, setClassificationResult] = useAtom(classificationResultAtom);

    useEffect(() => {
        if (!hasCaptured || !image) {
            setClassificationResult(null);
        }
    }, [hasCaptured, image, setClassificationResult]);

    useEffect(() => {
        if (model === null) {
            loadMobileNetModel().then(setModel);
            console.log('Model now loaded');
        } else {
            console.log('Model already loaded');
        }
    }, [model, setModel]);

    useEffect(() => {
        const classify = async () => {
            if (!model || !hasCaptured || !image) return;

            try {
                const results = await classifyImage(model, image); // image is toDataURL + canvas
                setClassificationResult(results.slice(0, 3)); // Top 3
            } catch (err) {
                console.error('Luokittelu epäonnistui:', err);
                setClassificationResult(null);
            }
        };

        classify();
    }, [model, hasCaptured, image]);

    /**
     * Resets the image capture state.
     * This function clears the captured image, resets the capture status
     */
    const resetCapture = () => {
        setImage(null);
        setHasCaptured(false);
        setMethod(null);
    };

    return (
        <div className={style.container}>
            <Header title={t('common.title')} />
            <div className={style.innerContainer}>
                <div className={style.innerContainer}>
                    <h2>{t('game.own.title')}</h2>
                    {classificationResult && (
                        <div className={style.classificationBox}>
                            <h3>Luokittelutulos:</h3>
                            <ul>
                                {classificationResult.map((res, idx) => (
                                    <li key={idx}>
                                        {res.className} ({(res.probability * 100).toFixed(1)} %)
                                    </li>
                                ))}
                            </ul>
                        </div>
                    )}
                    {!hasCaptured && method === null && (
                        <div className={style.selectionButtons}>
                            <Button
                                sx={{ fontSize: '14pt', minWidth: '140px' }}
                                variant="contained"
                                onClick={() => setMethod('camera')}
                            >
                                {t('game.own.useCamera', 'Käytä kameraa')}
                            </Button>
                            <Button
                                sx={{ fontSize: '14pt', minWidth: '140px' }}
                                variant="contained"
                                onClick={() => setMethod('upload')}
                            >
                                {t('game.own.uploadFile', 'Lataa kuva tiedostosta')}
                            </Button>
                        </div>
                    )}

                    {!hasCaptured && method === 'camera' && (
                        <CameraCapture
                            onCapture={setImage}
                            onDone={() => setHasCaptured(true)}
                        />
                    )}

                    {!hasCaptured && method === 'upload' && (
                        <FileUploadCapture
                            onCapture={setImage}
                            onDone={() => setHasCaptured(true)}
                        />
                    )}

                    {hasCaptured && image && (
                        <>
                            <img
                                src={image.toDataURL()}
                                alt="Kuvakaappaus"
                                style={{ width: '224px', height: '224px' }}
                            />
                            <Button
                                sx={{ fontSize: '14pt', minWidth: '140px' }}
                                variant="contained"
                                onClick={resetCapture}
                            >
                                {t('game.own.takeNew', 'Vaihda kuva')}
                            </Button>
                        </>
                    )}
                </div>
            </div>
            <Footer />
        </div>
    );
}
